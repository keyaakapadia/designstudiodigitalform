<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>draft3</title>
<style>
  :root{
    --slivers: 20;
    --height: 100vh;
    --thin: .55fr;
    --active: .95fr;
    --rest: 1fr;
    --focus-gap: min(72vw, 1200px);
    --t: 480ms;
    --e: cubic-bezier(.2,.75,.2,1);

    /* Cursor */
    --cursor-size: 64px;

    /* Popup (glass) */
    --bubble-bg: rgba(255,255,255,.16);
    --bubble-stroke: rgba(255,255,255,.55);
    --bubble-shadow: 0 18px 60px rgba(0,0,0,.45);
    --bubble-blur: 12px;

    /* Halftone */
    --dot-size: 6px;        /* grid dot diameter */
    --dot-gap: 10px;        /* spacing (grid cell size) */
    --ht-opacity: .28;      /* landing sliver dot strength */
    --ht-focus-opacity: .33;/* focus image dot strength */
    --tint-opacity: .35;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{
    height:100%;
    overflow:hidden;
    background:#000;
    color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    cursor:none; /* custom cursor */
  }

  .stage{height:var(--height);display:flex;align-items:stretch}
  .slices{
    width:100vw;height:100%;
    display:grid; grid-template-columns:repeat(var(--slivers), var(--rest));
    transition:grid-template-columns var(--t) var(--e);
    will-change:grid-template-columns;
  }

  /* Landing slivers: posterized sprite + per-sliver halftone + per-sliver hue */
  .sliver{
    position:relative;
    background-image:url("image.png");
    background-repeat:no-repeat;
    background-size:calc(var(--slivers)*100%) 100%;
    background-position:center;

    image-rendering: pixelated;
    filter: url(#bitmapify);  /* posterize + saturate */

    cursor:none;
    transition:filter var(--t) var(--e), transform 360ms ease;
  }
  /* tint over the landing image so each slice reads its palette hue slightly */
  .sliver::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(0deg, var(--slice-tint, transparent), var(--slice-tint, transparent));
    mix-blend-mode:multiply;
    opacity: var(--tint-opacity);
    pointer-events:none;
  }
  /* halftone dots over landing image */
  .sliver::before{
    content:"";
    position:absolute; inset:0;
    pointer-events:none;
    background:
      radial-gradient(circle at center,
        var(--slice-ht, #ffffff) 0 calc(var(--dot-size) / 2),
        transparent calc(var(--dot-size) / 2 + 0.1px) 100%);
    background-size: var(--dot-gap) var(--dot-gap);
    mix-blend-mode: hard-light; /* pop-art vibe */
    opacity: var(--ht-opacity);
  }

  .sliver:hover{ transform:scale(1.01); filter: url(#bitmapify) brightness(1.06) contrast(1.06); }
  .sliver.is-active{ z-index:2; filter: url(#bitmapify) brightness(1.08) contrast(1.08); }

  /* Focus panel: clicked image with tint + halftone */
  .focus-spacer{ position:relative; background:transparent; pointer-events:auto; overflow:hidden; }
  .focus-content{
    position:absolute; inset:0;
    background:#000;
    background-position:center;
    background-size:cover;
    background-repeat:no-repeat;

    image-rendering: pixelated;
    filter: url(#bitmapify);
  }
  .focus-content::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(0deg, var(--focus-tint, transparent), var(--focus-tint, transparent));
    mix-blend-mode:multiply;
    opacity: var(--tint-opacity);
    pointer-events:none;
  }
  .focus-content::before{
    content:"";
    position:absolute; inset:0;
    pointer-events:none;
    background:
      radial-gradient(circle at center,
        var(--focus-ht, #ffffff) 0 calc(var(--dot-size) / 2),
        transparent calc(var(--dot-size) / 2 + 0.1px) 100%);
    background-size: var(--dot-gap) var(--dot-gap);
    mix-blend-mode: hard-light;
    opacity: var(--ht-focus-opacity);
  }

  /* Glassy popups (multiple allowed within current sliver) */
  .bubble{
    position:absolute; z-index:3;
    max-width:min(440px, 76%);
    padding:18px 20px;
    color:#fff;

    /* glass */
    background: var(--bubble-bg);
    border: 1px solid var(--bubble-stroke);
    box-shadow: var(--bubble-shadow);
    backdrop-filter: blur(var(--bubble-blur)) saturate(150%);
    -webkit-backdrop-filter: blur(var(--bubble-blur)) saturate(150%);

    border-radius: 18px;
    outline: 1px solid rgba(255,255,255,.18);
    outline-offset: -4px;

    font-size:15px; line-height:1.45; letter-spacing:.1px;
    opacity:0; transform:translateY(10px) scale(.98);
    animation:bubble-in .35s var(--e) forwards;
  }
  .bubble .meta{
    margin:0 0 6px;
    font-size:11px; text-transform:uppercase; letter-spacing:.22em; opacity:.8;
  }
  .bubble .title{ font-weight:800; margin-bottom:6px; font-size:16px; }
  .bubble::after{
    /* inner light sweep for stronger glass feel */
    content:"";
    position:absolute; inset:0;
    border-radius:inherit;
    background:
      linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,0) 40%),
      radial-gradient(80% 50% at 0% 0%, rgba(255,255,255,.18), transparent 60%);
    mix-blend-mode: screen;
    pointer-events:none;
  }
  @keyframes bubble-in { to { opacity:1; transform:translateY(0) scale(1); } }

  /* Custom cursor (difference blend) */
  .cursor{
    position:fixed;
    width:var(--cursor-size);
    height:var(--cursor-size);
    margin-left:calc(var(--cursor-size) * -0.5);
    margin-top:calc(var(--cursor-size) * -0.5);
    left:0; top:0;
    background:url("https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQf2pHfZpXPHeFBfFgeaZj_UEz2St37G1eEOQ&s") no-repeat center/contain;
    mix-blend-mode:difference;
    pointer-events:none;
    z-index:9999;
    will-change: transform;
  }

  @media (max-width:700px){
    :root{
      --thin:.65fr; --active:.9fr; --focus-gap:min(85vw, 900px);
      --cursor-size:44px; --dot-size:5px; --dot-gap:9px;
    }
  }
</style>
</head>
<body>
<!-- Shared SVG bitmap filter (posterize + saturation boost) -->
<svg width="0" height="0" style="position:absolute;visibility:hidden" aria-hidden="true" focusable="false">
  <filter id="bitmapify" color-interpolation-filters="sRGB">
    <feColorMatrix type="saturate" values="1.5" />
    <feComponentTransfer>
      <!-- 12-step posterize. Fewer values => chunkier. -->
      <feFuncR type="discrete" tableValues="0 0.09 0.18 0.27 0.36 0.45 0.55 0.64 0.73 0.82 0.91 1"/>
      <feFuncG type="discrete" tableValues="0 0.09 0.18 0.27 0.36 0.45 0.55 0.64 0.73 0.82 0.91 1"/>
      <feFuncB type="discrete" tableValues="0 0.09 0.18 0.27 0.36 0.45 0.55 0.64 0.73 0.82 0.91 1"/>
      <feFuncA type="table"    tableValues="0 1"/>
    </feComponentTransfer>
  </filter>
</svg>

<div class="stage">
  <div class="slices" id="slices"></div>
</div>

<!-- custom cursor -->
<div class="cursor" id="cursor"></div>

<script>
  const SLIVERS = 20;
  const grid = document.getElementById('slices');

  /* Time-of-day bands (left → right) */
  const bands = [
    { name:'Night',   start:0,  end:4 },
    { name:'Sunrise', start:5,  end:8 },
    { name:'Day',     start:9,  end:14 },
    { name:'Sunset',  start:15, end:19 },
  ];
  const bandForIndex = i => bands.find(b => i>=b.start && i<=b.end) || bands[0];

  /* Palette from your reference image (left→right) */
  const palette = [
    '#1d2948','#1d2440','#202946','#2d3d64','#456194',
    '#526da4','#54669a','#716696','#905470','#99484c',
    '#ae4e41','#9f4a47','#915b78','#6c81b1','#7b7994',
    '#a88771','#a38166','#a58878','#ad8b70','#a28468'
  ];

  /* Hour labels */
  const hourLabelFromIndex = i => {
    const h = i % 24, n = (h + 1) % 24;
    return `${formatHour(h)}–${formatHour(n)}`;
  };
  const formatHour = h => {
    const isPM = h >= 12;
    const base = h % 12 === 0 ? 12 : (h % 12);
    return `${base} ${isPM ? 'PM' : 'AM'}`;
  };

  /* Stories */
  const cartNames = [
    'Midnight Halal','After Hours Noodles','Night Kati','Owl Taco','Churro Comet',
    'Bagel Planet','Sunrise Chaat','Tamalito Express','Morning Momo','Early Kebab',
    'Falafel & Co.','Taco Rápido','Momo Lane','Pupusa Corner','Bao Stop',
    'Kebab Cartel','Dumpling Dot','Arepa Mile','Sushi Sidewalk','Kathi Corner'
  ];
  const specialties = [
    'chicken over rice, white sauce','wok noodles with chili crisp','egg kati with green chutney',
    'al pastor with pineapple','warm churros, cinnamon sugar','sesame bagels & hot coffee',
    'masala chai & bun maska','corn tamales & café de olla','steamed momos, spicy chutney',
    'charcoal kebabs & saffron rice','herby falafel with pickles','birria tacos & consommé',
    'chicken momos, tomato achar','bean & cheese pupusas','fluffy bao, black vinegar',
    'lamb kebabs, sumac onions','crispy dumplings, soy & garlic','griddled arepas, queso',
    'street sushi rolls','paneer kathi rolls'
  ];
  const linePoolA = [
    "Foil crackles louder than traffic.","Steam smells like home.","We trade names and spice levels.",
    "Pickles, herbs, a squeeze of lemon.","White sauce first, then heat.","Stories travel faster than the smoke.",
    "First pour wakes the block.","Sizzle meets the subway rumble.","Five minutes — I’ll call your name.",
    "Golden hour paints the foil."
  ];
  const linePoolB = [
    "Cash crinkles; grill whispers.","You’ll make it — take this for the walk.","Add sauce? Trust me.",
    "Share a skewer, save a story.","Regulars recognized by footsteps.","Next time, bring a friend.",
    "We’re here till the lights blink.","Two minutes, almost ready.","Card or cash, love?","Take a seat on the curb."
  ];
  const stories = Array.from({length: SLIVERS}, (_, i) => {
    const hour = hourLabelFromIndex(i);
    const title = `${cartNames[i]} — ${hour}`;
    const lines = [
      `Hour ${hour}: special is ${specialties[i]}.`,
      linePoolA[i % linePoolA.length],
      linePoolB[(i * 3) % linePoolB.length]
    ];
    return { title, lines, nextLineIdx: 0 };
  });

  /* Build landing slivers (sprite positions + per-slice colors) */
  const slivers = [];
  for (let i = 0; i < SLIVERS; i++) {
    const d = document.createElement('div');
    d.className = 'sliver';
    d.dataset.i = i;
    d.style.backgroundPosition = `${(i/(SLIVERS-1))*100}% 50%`;
    d.style.setProperty('--slice-tint', palette[i]);
    d.style.setProperty('--slice-ht', palette[i]);
    d.addEventListener('click', (e)=>activate(i, e));
    grid.appendChild(d);
    slivers.push(d);
  }

  /* Focus area */
  const spacer = document.createElement('div');
  spacer.className = 'focus-spacer';
  const content = document.createElement('div');
  content.className = 'focus-content';
  spacer.appendChild(content);

  function templateWithSpacer(afterIndex){
    const cs = getComputedStyle(document.documentElement);
    const thin   = cs.getPropertyValue('--thin').trim();
    const active = cs.getPropertyValue('--active').trim();
    const parts  = [];
    for (let k=0;k<SLIVERS;k++){
      parts.push(k===afterIndex ? active : thin);
      if (k===afterIndex) parts.push(`var(--focus-gap)`);
    }
    return parts.join(' ');
  }

  let currentIndex = -1;
  const activeRects = []; // track current-sliver bubbles to avoid overlap

  function clearAllBubbles(){
    document.querySelectorAll('.bubble').forEach(b=>b.remove());
    activeRects.length = 0;
  }

  function activate(i, evt){
    // Insert focus panel next to clicked sliver
    if (spacer.isConnected) spacer.remove();
    slivers[i].insertAdjacentElement('afterend', spacer);
    slivers.forEach((el, idx)=> el.classList.toggle('is-active', idx===i));
    grid.style.gridTemplateColumns = templateWithSpacer(i);

    // Focus image + per-slice tint/halftone color
    const imgIdx = i + 1;
    content.style.backgroundImage = `url("image${imgIdx}.png")`;
    content.style.setProperty('--focus-tint', palette[i]);
    content.style.setProperty('--focus-ht', palette[i]);

    // IMPORTANT: prevent popups from other slivers overlapping
    clearAllBubbles();

    currentIndex = i;

    // create one at click, plus a short burst
    spawnClickBubble(evt);
    burstForCurrent();
  }

  function reset(){
    if (spacer.isConnected) spacer.remove();
    grid.style.gridTemplateColumns = `repeat(${SLIVERS}, var(--rest))`;
    slivers.forEach(el=> el.classList.remove('is-active'));
    clearAllBubbles();
    currentIndex = -1;
  }
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') reset(); });
  document.body.addEventListener('click', e=>{
    if (!e.target.classList.contains('sliver') &&
        !e.target.classList.contains('bubble') &&
        spacer.isConnected) reset();
  });

  /* ---- Multiple popups within current sliver (non-overlapping) ---- */
  function overlaps(a,b,margin=10){
    return !(
      a.x + a.w + margin < b.x ||
      b.x + b.w + margin < a.x ||
      a.y + a.h + margin < b.y ||
      b.y + b.h + margin < a.y
    );
  }
  function findFreeSlot(x, y0, w, h){
    const pad = 18;
    const maxX = content.clientWidth - w - pad;
    const maxY = content.clientHeight - h - pad;
    let xFixed = Math.max(pad, Math.min(x, maxX));

    const step = Math.max(14, Math.floor(h * 0.6));
    const yStart = Math.max(pad, Math.min(y0, maxY));
    const candidates = [yStart];
    for (let k=1;k<80;k++){
      const yUp = yStart - k*step, yDn = yStart + k*step;
      if (yUp  >= pad) candidates.push(yUp);
      if (yDn  <= maxY) candidates.push(yDn);
      if (yUp < pad && yDn > maxY) break;
    }
    for (const y of candidates){
      const c = {x:xFixed,y,w,h};
      let ok = true; for (const r of activeRects){ if (overlaps(c,r)) { ok=false; break; } }
      if (ok) return {x:xFixed,y};
    }
    return {x:xFixed,y:maxY};
  }

  function createBubble({x,y,bandName,title,lines}){
    const b = document.createElement('div');
    b.className = `bubble`;
    b.innerHTML = `
      <div class="meta">${escapeHtml(bandName)}</div>
      <div class="title">${escapeHtml(title)}</div>
      <div class="body">${lines.map(s=>escapeHtml(s)).join('<br>')}</div>
    `;
    content.appendChild(b);

    // place without overlapping existing ones (current sliver only)
    const bw=b.offsetWidth, bh=b.offsetHeight;
    const slot = findFreeSlot(x ?? 40, y ?? 40, bw, bh);
    b.style.left = `${slot.x}px`;
    b.style.top  = `${slot.y}px`;

    const ref = {x:slot.x,y:slot.y,w:bw,h:bh,el:b};
    activeRects.push(ref);

    // fade then remove automatically
    const fadeMs = 5000 + Math.random()*1400;
    const killMs = fadeMs + 900;
    setTimeout(()=> b.style.opacity = .0, fadeMs);
    setTimeout(()=>{
      const idx = activeRects.findIndex(r=>r.el===b);
      if (idx>-1) activeRects.splice(idx,1);
      b.remove();
    }, killMs);
    return b;
  }
  const escapeHtml = s => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  function nextLinesForSliver(i, count=1){
    const s = stories[i]; const out = [];
    for (let k=0;k<count;k++){ out.push(s.lines[s.nextLineIdx % s.lines.length]); s.nextLineIdx++; }
    return out;
  }

  function spawnClickBubble(evt){
    if (currentIndex<0) return;
    const rect = content.getBoundingClientRect();
    const cx = Math.max(0, Math.min(evt.clientX - rect.left, rect.width));
    const cy = Math.max(0, Math.min(evt.clientY - rect.top, rect.height));
    const band = bandForIndex(currentIndex);
    const s = stories[currentIndex];
    createBubble({
      x: cx, y: cy,
      bandName: band.name,
      title: s.title,
      lines: nextLinesForSliver(currentIndex, 2)
    });
  }

  function burstForCurrent(){
    if (currentIndex<0) return;
    const s = stories[currentIndex];
    const count = 3 + Math.floor(Math.random()*3); // 3–5 extra bubbles
    for (let k=0;k<count;k++){
      setTimeout(()=>{
        const x = 40 + Math.random()*(content.clientWidth  - 80);
        const y = 40 + Math.random()*(content.clientHeight - 120);
        const band = bandForIndex(currentIndex);
        createBubble({
          x, y,
          bandName: band.name,
          title: s.title,
          lines: nextLinesForSliver(currentIndex, 1 + (Math.random()<0.5?1:0))
        });
      }, 420 + k*680 + Math.random()*260);
    }
  }

  /* Custom cursor follower */
  const cursorEl = document.getElementById('cursor');
  window.addEventListener('mousemove', (e)=>{
    cursorEl.style.transform = `translate(${e.clientX}px, ${e.clientY}px)`;
  }, {passive:true});
</script>
</body>
</html>
